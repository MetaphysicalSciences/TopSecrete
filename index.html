<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Portal — Encrypt & Package</title>
  <style>
    :root{--bg:#f6f8fb;--card:#ffffff;--accent:#0f6fc2;--muted:#5b6b7a;--glass:rgba(255,255,255,0.6)}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#eef6ff 0%,#f8fbff 100%);color:#0f1724}
    .wrap{max-width:1080px;margin:36px auto;padding:20px}
    header{display:flex;align-items:center;gap:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(180deg,#e9f6ff,#d8ecff);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent);font-size:20px;box-shadow:0 6px 20px rgba(15,111,194,0.08)}
    h1{font-size:22px;margin:0}
    .lead{color:var(--muted);margin-top:6px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:20px}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(9,30,66,0.04);border:1px solid rgba(15,111,194,0.04)}
    label{display:block;margin-bottom:8px;font-weight:700}
    input[type=file],input[type=number],input[type=text],input[type=password],select{width:100%;padding:12px;border-radius:10px;border:1px solid #e9f3ff;background:#fbfeff;font-size:14px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--accent);color:white;box-shadow:0 8px 24px rgba(15,111,194,0.12)}
    .btn-ghost{background:transparent;border:1px solid rgba(15,111,194,0.08);color:var(--accent)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:#94a3b8}
    .progress{height:10px;background:#eef6ff;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#0f6fc2,#3fb0ff);transition:width 300ms ease}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .help{background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.6));padding:12px;border-radius:10px;border:1px solid rgba(15,111,194,0.03)}
    .list{padding-left:18px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">SP</div>
        <div>
          <h1>Secure Portal — Encrypt & Package</h1>
          <div class="lead">Browser-based AES‑256 layered encryption. Files stay in your browserl.</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2 style="margin-top:0">Create encrypted package</h2>
        <p class="muted">Upload a file, set the number of nested encryption layers and decoys, pick a password and download a single package file.</p>

        <div style="margin-top:14px">
          <label>File</label>
          <input id="inputFile" type="file" />
        </div>

        <div style="margin-top:12px" class="row">
          <div>
            <label>Password</label>
            <input id="password" type="password" placeholder="Choose a strong password (min 12 chars)" />
            <div class="small">Tip: use a long, unique passphrase.</div>
          </div>
          <div>
            <label>Layers</label>
            <input id="layers" type="number" min="1" max="99" value="35" />
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <div>
            <label>Decoys</label>
            <input id="decoys" type="number" min="0" max="500" value="50" />
          </div>
          <div>
            <label>Output extension</label>
            <input id="extension" type="text" value="secureenc" />
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:14px;align-items:center">
          <button id="encryptBtn" class="btn btn-primary">Create package</button>
          <button id="downloadSample" class="btn btn-ghost">Download sample</button>
          <div style="flex:1;text-align:right" class="small muted">Client-side only • AES‑GCM PBKDF2</div>
        </div>

        <div style="margin-top:16px">
          <div class="progress" aria-hidden><i id="progressBar"></i></div>
        </div>

        <div style="margin-top:14px" class="help">
          <strong class="small">Technical summary</strong>
          <div class="small muted" style="margin-top:8px">This page uses the Web Crypto API (PBKDF2 + AES‑GCM). Each layer derives a fresh key and IV. The manifest stores salts/IVs so decryption is possible with the original password. Use this for experimentation and prototypes; for production, pair with a security review.</div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Decrypt package</h3>
        <p class="muted">Upload a package and enter the password to recover the original file.</p>
        <div style="margin-top:10px">
          <input id="inputPackage" type="file" />
        </div>
        <div style="margin-top:10px" class="row">
          <div>
            <input id="decryptPassword" type="password" placeholder="Password" />
          </div>
          <div style="display:flex;align-items:flex-end">
            <button id="decryptBtn" class="btn btn-primary">Decrypt</button>
          </div>
        </div>

        <div id="decryptOutput" style="margin-top:12px"></div>

        <hr style="margin:16px 0;border:none;border-top:1px solid rgba(15,111,194,0.04)" />
        <div class="small muted">Includes decoy listing and a download link for the decrypted file when successful.</div>

        <div style="margin-top:12px" class="small muted">
          <strong>
        </div>
      </div>
    </div>

    <div style="margin-top:18px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Audit checklist</strong>
          <div class="small muted">If you plan to use this beyond testing, consider: secure password policies, thorough key-handling review, and server-side design for backups & sharing.</div>
        </div>
        <div class="small muted">Version: 7.3 (client-only)</div>
      </div>

      <div style="margin-top:12px" class="list">
        <ul>
          <li>In-browser encryption — no upload unless you choose to share.</li>
          <li>Configurable nested layers and decoys.</li>
          <li>Downloadable single-file package with chosen extension.</li>
        </ul>
      </div>
    </div>

    <footer>
      <div class="muted">Polished prototype UI. To further customize colors, fonts, or add server storage, tell me what style you want and I’ll update the file.</div>
    </footer>
  </div>

<script>
// --- same core crypto implementation, refined UI hooks ---
function bufToB64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)))}
function b64ToBuf(b64){const bin=atob(b64);const l=bin.length;const a=new Uint8Array(l);for(let i=0;i<l;i++)a[i]=bin.charCodeAt(i);return a.buffer}
function randBytes(len){const b=new Uint8Array(len);crypto.getRandomValues(b);return b}
async function deriveKey(password, salt, iterations=150000){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations,hash:'SHA-256'}, baseKey, {name:'AES-GCM',length:256}, false, ['encrypt','decrypt']);
}
async function aesGcmEncrypt(key, iv, data){return crypto.subtle.encrypt({name:'AES-GCM',iv}, key, data)}
async function aesGcmDecrypt(key, iv, data){return crypto.subtle.decrypt({name:'AES-GCM',iv}, key, data)}
function makeRandomBlob(size){const arr=new Uint8Array(size);crypto.getRandomValues(arr);return arr.buffer}
function randomFilename(){const exts=['txt','jpg','pdf','docx','xls','png','dat','log','csv'];const n=Math.floor(Math.random()*100000);return `decoy_${n}.${exts[Math.floor(Math.random()*exts.length)]}`}

const progressBar = document.getElementById('progressBar');
function setProgress(p){progressBar.style.width = Math.max(0,Math.min(100,p)) + '%'}

// Encryption
document.getElementById('encryptBtn').addEventListener('click', async ()=>{
  const fileInput = document.getElementById('inputFile');
  const pw = document.getElementById('password').value;
  const layers = parseInt(document.getElementById('layers').value,10)||35;
  const decoys = parseInt(document.getElementById('decoys').value,10)||50;
  const extension = (document.getElementById('extension').value||'secureenc').replace(/[^a-zA-Z0-9_-]/g,'');
  if(!fileInput.files.length){alert('Pick a file');return}
  if(!pw || pw.length<8){if(!confirm('Password seems short. Continue?'))return}
  const file = fileInput.files[0];
  const arrayBuffer = await file.arrayBuffer();
  let current = arrayBuffer;
  const layerMeta = [];
  for(let i=0;i<layers;i++){
    const salt = randBytes(16).buffer; const iv = randBytes(12).buffer;
    const key = await deriveKey(pw, salt);
    const ct = await aesGcmEncrypt(key, iv, current);
    layerMeta.push({salt:bufToB64(salt),iv:bufToB64(iv),ct:bufToB64(ct)});
    current = ct;
    setProgress(((i+1)/layers)*70);
    await new Promise(r=>setTimeout(r,1));
  }
  const decoyList = [];
  for(let i=0;i<decoys;i++){
    const size = 1024 + Math.floor(Math.random()*100000);
    const buf = makeRandomBlob(size);
    const name = randomFilename();
    decoyList.push({name, data: bufToB64(buf)});
  }
  setProgress(85);
  const manifest = {meta:{created:new Date().toISOString(),originalName:file.name,layers:layers,decoys:decoys,algorithm:'PBKDF2+AES-GCM'},layers: layerMeta,decoys: decoyList};
  const blob = new Blob([JSON.stringify(manifest)],{type:'application/octet-stream'});
  const fname = file.name + '.' + extension;
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');a.href=url;a.download=fname;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
  setProgress(100);
  setTimeout(()=>setProgress(0),600);
  alert('Package created: ' + fname);
});

document.getElementById('downloadSample').addEventListener('click',()=>{
  const decoys = [];
  for(let i=0;i<3;i++){decoys.push({name:`sample_${i}.txt`, data:bufToB64(new TextEncoder().encode('sample decoy '+i))})}
  const manifest = {meta:{created:new Date().toISOString(),originalName:'sample',layers:1,decoys:3},layers:[],decoys};
  const blob = new Blob([JSON.stringify(manifest)],{type:'application/octet-stream'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sample.secureenc'; a.click(); URL.revokeObjectURL(a.href);
});

// Decrypt
document.getElementById('decryptBtn').addEventListener('click', async ()=>{
  const pkgInput = document.getElementById('inputPackage');
  const pw = document.getElementById('decryptPassword').value;
  const out = document.getElementById('decryptOutput'); out.innerHTML='';
  if(!pkgInput.files.length){alert('Choose a package file');return}
  if(!pw){alert('Enter password');return}
  const file = pkgInput.files[0];
  const text = await file.text();
  let manifest; try{manifest = JSON.parse(text)}catch(e){alert('Not a valid package');return}
  if(!manifest.layers || !Array.isArray(manifest.layers)){
    out.innerHTML = '<div class="muted">No encrypted layers found.</div>';
    return;
  }
  try{
    let current = b64ToBuf(manifest.layers[manifest.layers.length-1].ct);
    for(let i=manifest.layers.length-1;i>=0;i--){
      const meta = manifest.layers[i];
      const salt = b64ToBuf(meta.salt); const iv = b64ToBuf(meta.iv);
      const key = await deriveKey(pw, salt);
      const decrypted = await aesGcmDecrypt(key, iv, current);
      current = decrypted;
      setProgress(((manifest.layers.length - i)/manifest.layers.length)*80);
    }
    const outBlob = new Blob([current]);
    const url = URL.createObjectURL(outBlob);
    const a = document.createElement('a'); a.href=url; a.download = manifest.meta?.originalName || 'decrypted.bin'; a.textContent='Download decrypted file'; out.appendChild(a);
    if(manifest.decoys && manifest.decoys.length){
      const dlist = document.createElement('div'); dlist.className='muted'; dlist.innerHTML='<strong>Decoys included:</strong><ul>'+(manifest.decoys.map(d=>`<li>${d.name} (${Math.round((atob(d.data).length)/1024)} KB)</li>`).join(''))+'</ul>';
      out.appendChild(dlist);
    }
    setTimeout(()=>setProgress(0),600);
  }catch(e){console.error(e);alert('Decryption failed — wrong password or corrupted package');setProgress(0)}
});
</script>
</body>
</html>

